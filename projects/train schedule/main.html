<!DOCTYPE html>
<html>
<head>

	<title>列车时刻表查询</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta charset="utf-8">
	<link rel="stylesheet" href="css/jquery.mobile-1.4.5.min.css">

	
</head>
<body>
	<div data-role="page" id="index">
		<div data-role="header" data-position="fixed">
			<h1>列车时刻表查询</h1>
		</div>
		<div role="main" class="ui-content">
			<div class="ui-field-contain">
				<label>发车站:</label>
				<input type="text" name="text-basic" id="search-begin" value="">
			</div>
			<div class="ui-field-contain">
				<label>终点站:</label>
				<input type="text" name="text-basic" id="search-end" value="">
			</div>
			<div class="ui-field-contain">
				<label>车次:</label>
				<input type="text" name="text-basic" id="search-no" value="">
			</div>
			<input type="button" value="搜索" id="search-submit">
			<ul data-role="listview" data-inset="true" id="list">
			</ul>
		</div>
		<div data-role="footer" data-position="fixed">
			<div data-role="navbar">
				<ul>
					<li><a href="#index" data-icon="grid" class="ui-btn-active ui-state-persist">查询</a></li>
					<li><a href="#collection" data-icon="star">收藏</a></li>
					<li><a href="#" data-icon="gear">设置</a></li>
				</ul>
			</div>
		</div>
	</div>
	<div data-role="page" id="detail">

		<div data-role="header" data-position="fixed">
			<h1>列车时刻表查询</h1>
		</div>

		<div role="main" class="ui-content">
			<h2></h2>
			<table data-role="table" id="movie-table" data-mode="reflow" class="ui-responsive">
				<thead>
					<tr>
						<th data-priority="1">站名</th>
						<th data-priority="persist">到站时间</th>
						<th data-priority="persist">出发时间</th>
					</tr>
				</thead>
				<tbody>
				</tbody>
			</table>
			<a href="#" class="ui-btn ui-corner-all" data-rel="back">返回</a>
			<a href="#collection" id="collectinon-btn" data-no="" class="ui-btn ui-corner-all" >加入收藏</a>
		</div>

		<div data-role="footer">
			<div data-role="navbar">
				<ul>
					<li><a href="#index" data-icon="grid" class="ui-btn-active ui-state-persist">查询</a></li>
					<li><a href="#collection" data-icon="star">收藏</a></li>
					<li><a href="#" data-icon="gear">设置</a></li>
				</ul>
			</div>
		</div>
	</div>
	<div data-role="page" id="collection">
		<div data-role="header" data-position="fixed">
			<h1>收藏列表</h1>
		</div>
		<div role="main" class="ui-content">
			<ul data-role="listview" data-inset="true" id="collection-list">

			</ul>
		</div>
		<div data-role="footer" data-position="fixed">
			<div data-role="navbar">
				<ul>
					<li><a href="#index" data-icon="grid" >查询</a></li>
					<li><a href="#collection" data-icon="star" class="ui-btn-active ui-state-persist">收藏</a></li>
					<li><a href="#" data-icon="gear">设置</a></li>
				</ul>
			</div>
		</div>
	</div>
	<script src="http://libs.baidu.com/jquery/1.9.0/jquery.js"></script>
	<script src="js/jquery.mobile-1.4.5.min.js" ></script>
	<script type="text/javascript">
var urlPre = "http://crossorigin.me/"; //跨域中转
var url1 = "http://www.webxml.com.cn/WebServices/TrainTimeWebService.asmx/getStationAndTimeByStationName?UserID=";
var url2 = "http://www.webxml.com.cn/WebServices/TrainTimeWebService.asmx/getStationAndTimeDataSetByLikeTrainCode?UserID=";
var url3 = "http://www.webxml.com.cn/WebServices/TrainTimeWebService.asmx/getDetailInfoByTrainCode?UserID=";

var getTrainList=function (){
	if($("#search-no").val() || $("#search-begin").val()&&$("#search-end").val() ){
		var searchButton = $(this);
		searchButton.button("option", "disabled", true);
		$.mobile.loading('show');
		var _data={};
		var _url=url1;
		if(!$('#search-no').val()){
			_data.StartStation=$('#search-begin').val();
			_data.ArriveStation=$('#search-end').val();
		}else{
			_data.TrainCode=$('#search-no').val();
			_url=url2;
		}
		$.get(urlPre+_url,_data,function(data){
			var list=$('#list');
			var timeTalbes=$(data).find("TimeTable");
			var _arr=[];
			timeTalbes.each(function(index,obj){
				var i=index;
				if(i>10) return false;
				var that=$(this);
				if(that.find("FirstStation").text()=='数据没有被发现'){
					alert("数据没有被发现");
					return false;
				}
				_arr.push('<li><a href="#" data-no="' + that.find("TrainCode").text() + '">' +
					'<h2>' + that.find("TrainCode").text() + '次</h2>' +
					'<p>' + that.find("FirstStation").text() + ' - ' + that.find("LastStation").text() + '</p>' +
					'<p>用时：' + that.find("UseDate").text() + '</p>' +
					'<p class="ui-li-aside">' + that.find("StartTime").text() + ' 开</p>' +
					'</a></li>');

			});
			if(_arr.length>0){
				list.html(_arr.join(""));
				list.listview('refresh');
			}
			$.mobile.loading('hide');
			searchButton.button("option", "disabled", false);


		});
	}else{
		alert("请输入必须数据");{}
	}
};
var isAjax=false;

var getInfoByTrainCode=function(){
	if(isAjax) return;
	isAjax=true;
	$.mobile.loading("show");
	var trainCode = $(this).attr("data-no");
	$.get(urlPre+url3,{TrainCode:trainCode},function(data){
		$("#detail").find(".ui-content h2").first().html(trainCode+"次");
		$("#collectinon-btn").attr("data-no",trainCode);
		var tbody = $("#detail").find(".ui-content tbody");
		tbody.html("");
		$(data).find("TrainDetailInfo").each(function(index,obj){
			var tr=$("<tr></tr>");
			var that=$(this);
			tr.html('<td>' + that.find("TrainStation").text() + '</td>' +
				'<td>' + that.find("ArriveTime").text() + '</td>' +
				'<td>' + that.find("StartTime").text() + '</td>');
			tbody.append(tr);
		});

		$.mobile.loading("hide");
		isAjax=false;
		$.mobile.changePage("#detail");
	});

};
//加入收藏
var addCollection = function(){
	var that= $(this);
	var no=that.attr("data-no");
	var item=$("#list").find("a[data-no="+no+"]").parent().html();
	var li="<li>"+item+"</li>";
	$("#collection-list").append(li);
}
var bindEvent=function(){
	$('#search-submit').on("click",getTrainList);
	$('#list').on('click','a',getInfoByTrainCode);
	$("#collectinon-btn").on('click',addCollection);

};

$(document).on('pageinit','#index',function(){
	bindEvent();
});
</script>
</body>
</html>